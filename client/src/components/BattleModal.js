import React, {useState, useEffect, useContext} from 'react';
import { ContractContext } from '../App';
import {
  Button,
  Divider,
  Grid,
  Header,
  Icon,
  Segment,
  Modal,
} from 'semantic-ui-react'


const BattleModal = ({ myIdx, userIdx, myPower, userPower, setMyPower, setUserPower }) => {
  const state = useContext(ContractContext);
  const {accountContract, barrackContract, accounts} = state;
  const [initialized, setInitialize] = useState(false);
  const [battled, setBattled] = useState(false);
  const [spyed, setSpyed] = useState(false);
  const [marching, setMarching] = useState(false);
  const [marchProgress, setMarchProgress] = useState(0);
  const [marchPeriod, setMarchPeriod] = useState(0);
  const [marchTimeNeed, setMarchTimeNeed] = useState(0);
  
  const [battleLog, setBattleLog] = useState("");  
  //const [battleResult, setBattleResult] = useState(false) 
  const [spyResult, setSpyResult] = useState(false); // True = win

  const march = async() => {
    await barrackContract.methods.startMarch(userIdx).send({from: accounts[0]});
    const getMarchTime = await barrackContract.methods.getMarchTime().call({from: accounts[0]});
    const nowStartPeriod = parseInt( getMarchTime[0] );
    const marchingTimeNeed = parseInt( getMarchTime[1] );
    //console.log("createSoldier: ", nowStartPeriod, createTimeNeed);
    if(marchingTimeNeed == 0) {
        alert("Not enough resource!");
        return;
    }
    setMarching(true);
    setMarchPeriod(nowStartPeriod);
    setMarchTimeNeed(marchingTimeNeed)
  }
  const goBattle = async () => {
    await barrackContract.methods.attack(myIdx, userIdx).send({from: accounts[0]});
    await barrackContract.methods.updateMarch(accounts[0]).send({from: accounts[0]});
    // const log = await barrackContract.methods.getBattleLog().call({from: accounts[0]});
    // const myNewPower = await accountContract.methods.getUserPowerById(myIdx).call({from: accounts[0]});
    // const userNewPower = await accountContract.methods.getUserPowerById(userIdx).call({from: accounts[0]});
    setBattled(true);
    setMarching(false);
    setMarchPeriod(0);
    setMarchTimeNeed(0);
    // setBattleLog(log);
    // setMyPower(myNewPower);
    // setUserPower(userNewPower);
  }

  const sendSpy = async () => {
    console.log(accounts);
    console.log(barrackContract);
    const spyResult = await barrackContract.methods.sendSpy(myIdx, userIdx).call({from: accounts[0]});

    
    setSpyed(true);
    if(spyResult){
      const myNewPower = await accountContract.methods.getUserPowerById(myIdx).call({from: accounts[0]});
      const userNewPower = await accountContract.methods.getUserPowerById(userIdx).call({from: accounts[0]});
      setSpyResult(true);
      setMyPower(myNewPower);
      setUserPower(userNewPower);
    }
  }
  const updateMarch = () => {
    if(!marching){
      console.log("???")
      return 
    }
    if(marchPeriod < marchTimeNeed){
        setMarchPeriod(marchPeriod + 3);
    }
    else goBattle();
  }

  useEffect(() => {
    const init = async () => {
      const getMarchTime = await barrackContract.methods.getMarchTime().call({from: accounts[0]});
      const nowStartPeriod = parseInt( getMarchTime[0] );
      const marchingTimeNeed = parseInt( getMarchTime[1] );

      setMarchPeriod(nowStartPeriod);
      setMarchTimeNeed(marchingTimeNeed);
      setMarching(true);
    }
    if(barrackContract && accounts.length > 0) {
      if(!initialized) {
        init();
      }
    }

    var handle;
    setMarchProgress(marching ? marchTimeNeed === 0 ? 100 : marchPeriod/marchTimeNeed*100 > 100 ? 
                    100:marchPeriod/ marchTimeNeed*100: 0);

    if(marching) {
      handle = setTimeout(() => {
        updateMarch;
      }, 3000);
    }

    return () => {
      clearTimeout(handle);
  }
  }, [state, marchPeriod, marchTimeNeed])

  return <>
  {!marching ?
    <Modal.Content>
      <Segment placeholder>
        <Grid columns={2} stackable textAlign='center'>
          <Divider vertical>VS</Divider>
          <Grid.Row verticalAlign='middle'>
            <Grid.Column>
              <Header icon>
                <Icon name='user' />
                You
              </Header>

              <div>
                {
                  ["Power: ",
                    myPower === -1 ?
                    <Icon key="loading" loading name='spinner' />
                    :
                    `${myPower}`
                  ]
                }
              </div>
            </Grid.Column>

            <Grid.Column>
              <Header icon>
                <Icon name='user secret' />
                Enemy
              </Header>
              <div>
              <div>
                {
                  ["Power: ",
                    userPower === -1 ?
                    <Icon key="loading" loading name='spinner' />
                    :
                    `${userPower}`
                  ]
                }
              </div>
              </div>
            </Grid.Column>
          </Grid.Row>
        </Grid>
      </Segment>
      <Button animated='fade' color='red' fluid inverted attached='bottom' onClick={() => march()}>
        <Button.Content visible>Attack</Button.Content>
        <Button.Content hidden>
          <Icon name='fire' />
        </Button.Content>
      </Button>
       
      {
        !spyed ?
        <Button animated='fade' color='red' fluid inverted attached='bottom' onClick={() => sendSpy()}>
          <Button.Content visible>Send Spy</Button.Content>
          <Button.Content hidden>
            <Icon name='fire' />
          </Button.Content>
        </Button>
        :
        spyResult?
        <Button positive fluid>
          spy success!
        </Button>
        :
        <Button negative fluid>
          spy failed!
        </Button>
      }
    </Modal.Content>
    :
      battled ?
      <Modal.Content>
        <Grid columns='equal' divided padded>
          <Grid.Row stretch>
            <Grid.Column>
              {battleLog}
            </Grid.Column>
          </Grid.Row>
        </Grid>
      </Modal.Content>
      :
      <Modal.Content>
        <Grid columns='equal' divided padded>
          <Grid.Row stretch>
              <Header as='h4'>
                March progress
              </Header>
              <Progress progress='percent'  progress='percent'  percent={marchProgress} indicating />
              <div style={{textAlign: 'center'}}>
              <Button disabled={marchProgress !== 100} primary onClick={() => goBattle()} >
                  Battle!
              </Button>
              </div>
          </Grid.Row>
        </Grid>
      </Modal.Content>
    
    }
  </>
}

export default BattleModal;


// 戰鬥報告\------------------------------------------------------------------------------------------------------------------------------------------------------------<<第1回合>>-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方9名神射手進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺2名敵人，剩餘5名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------剩餘一名受傷敵人，剩餘6的生命------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由防守方7名神射手進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊神射手                              n對敵方有效傷害為4，每2名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺3名敵人，剩餘6名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------剩餘一名受傷敵人，剩餘1的生命------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由防守方5名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺1名敵人，剩餘4名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------剩餘一名受傷敵人，剩餘6的生命------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方4名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊神射手                              n對敵方有效傷害為3，每2名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺2名敵人，剩餘5名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方1名火砲進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊火砲                              n對敵方有效傷害為10，每1名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺1名敵人，選定兵種造到殲滅------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------進攻方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 4  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 6 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 1------------------------------------------------------------------------------------------------------------------------------------------------------------防守方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 5  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 5 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 0------------------------------------------------------------------------------------------------------------------------------------------------------------<<第2回合>>-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方6名神射手進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊神射手                              n對敵方有效傷害為4，每2名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺3名敵人，剩餘2名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由防守方2名神射手進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊神射手                              n對敵方有效傷害為4，每2名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------n尚有一名敵人剩餘1生命,優先攻擊------------------------------------------------------------------------------------------------------------------------------------------------------------n擊殺受傷敵人------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺0名敵人，剩餘5名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------剩餘一名受傷敵人，剩餘1的生命------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由防守方5名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊火砲                              n對敵方有效傷害為4，每3名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺1名敵人，選定兵種造到殲滅------------------------------------------------------------------------------------------------------------------------------------------------------------尚有2個友方兵種未攻擊------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------n尚有一名敵人剩餘6生命,優先攻擊------------------------------------------------------------------------------------------------------------------------------------------------------------n傷害不足擊殺受傷敵人，對其造成4生命損傷------------------------------------------------------------------------------------------------------------------------------------------------------------n敵人剩餘2生命------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方4名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊神射手                              n對敵方有效傷害為3，每2名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺2名敵人，選定兵種造到殲滅------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------進攻方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 4  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 5 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 0------------------------------------------------------------------------------------------------------------------------------------------------------------防守方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 5  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 0 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 0------------------------------------------------------------------------------------------------------------------------------------------------------------<<第3回合>>-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方5名神射手進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------n尚有一名敵人剩餘2生命,優先攻擊------------------------------------------------------------------------------------------------------------------------------------------------------------n擊殺受傷敵人------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺1名敵人，剩餘3名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由防守方3名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊神射手                              n對敵方有效傷害為3，每2名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------n尚有一名敵人剩餘1生命,優先攻擊------------------------------------------------------------------------------------------------------------------------------------------------------------n擊殺受傷敵人------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺1名敵人，剩餘3名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方4名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺1名敵人，剩餘2名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------進攻方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 4  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 3 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 0------------------------------------------------------------------------------------------------------------------------------------------------------------防守方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 2  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 0 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 0------------------------------------------------------------------------------------------------------------------------------------------------------------<<第4回合>>-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方3名神射手進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺0名敵人，剩餘2名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------剩餘一名受傷敵人，剩餘2的生命------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由防守方2名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊神射手                              n對敵方有效傷害為3，每2名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺1名敵人，剩餘2名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方4名守衛者進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------n尚有一名敵人剩餘2生命,優先攻擊------------------------------------------------------------------------------------------------------------------------------------------------------------n擊殺受傷敵人------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺0名敵人，剩餘1名敵人------------------------------------------------------------------------------------------------------------------------------------------------------------剩餘一名受傷敵人，剩餘2的生命------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------進攻方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 4  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 2 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 0------------------------------------------------------------------------------------------------------------------------------------------------------------防守方剩餘兵力: ------------------------------------------------------------------------------------------------------------------------------------------------------------守衛者: 1  ------------------------------------------------------------------------------------------------------------------------------------------------------------神射手: 0 ------------------------------------------------------------------------------------------------------------------------------------------------------------火砲: 0------------------------------------------------------------------------------------------------------------------------------------------------------------<<第5回合>>-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------由進攻方2名神射手進攻---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------選擇攻擊守衛者                              n對敵方有效傷害為2，每4名士兵攻擊，可擊殺一名敵軍------------------------------------------------------------------------------------------------------------------------------------------------------------n尚有一名敵人剩餘2生命,優先攻擊------------------------------------------------------------------------------------------------------------------------------------------------------------n擊殺受傷敵人------------------------------------------------------------------------------------------------------------------------------------------------------------擊殺0名敵人，選定兵種造到殲滅------------------------------------------------------------------------------------------------------------------------------------------------------------進攻結束------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------進攻方獲勝"
